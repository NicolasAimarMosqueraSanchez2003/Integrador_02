<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="asset/css/estilos.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Madimi+One&family=Orbitron:wght@400..900&display=swap" rel="stylesheet">
    <title>Productos</title>
</head>

<body>
    <header>
        <div class="Logo">
            <img src="asset/imagenes/Logo_Empreza.png" alt="Logo Kiosco Edna" class="Imagen_Logo">
        </div>
        
        <h1 class="Banner">
            Kiosco Edna
        </h1>

        <nav class="Menu">
            <div class="Navegador">
                <div class="Productos"><a href="/">Productos</a></div>
                <div class="Alta"><a href="/alta">Alta de Productos</a></div>
                <div class="Contacto"><a href="/contacto">Contacto</a></div>
                <div class="Nosotros"><a href="/nosotros">Nosotros</a></div>
                <div class="Carrito"><a href="/carrito" class="btn btn-carrito">üõí Ver Carrito</a></div>
            </div>
        </nav>
    </header>

    <main>
        <h1>Listado de Productos</h1>

        <form action="/buscar" method="GET" class="Contenedor_Buscador">
            <input type="search" name="q" class="Buscador" placeholder="Buscar productos por nombre">
        </form>
    
        {{#each productos}}
            <div style="border: 1px solid #ccc; padding: 10px; margin-bottom: 10px;">
                <h2>{{nombre}}</h2>
                {{#if foto}}
                <img src="{{foto}}" alt="{{nombre}}" width="200" />
                {{/if}}
                <p><strong>Precio:</strong> ${{precio}}</p>
                <p><strong>Stock:</strong> {{stock}}</p>
                <p><strong>Marca:</strong> {{marca}}</p>
                <p><strong>Categor√≠a:</strong> {{categoria}}</p>
                <p><strong>Descripci√≥n:</strong> {{descripcion_corta}}</p>
            </div>
            <div>
                <button class="btn-editar" data-id="{{this._id}}">Editar</button>
                <button class="btn-eliminar" data-id="{{this._id}}">Eliminar</button>
                <button class="btn-agregar-carrito" data-id="{{_id}}" data-precio="{{precio}}" data-nombre="{{nombre}}">A√±adir al carrito</button>
            </div>
        {{/each}}
    </main>

    <footer>
        <h2>
            Kiosco Edna
        </h2>

        <section class="Info">
            <div class="Direccion">
                <h3>
                    direcci√≥n
                </h3>
            
                <p>
                    Av. de Mayo 2011
                </p>            
            </div>

            <div class="Horario">
                <h3>
                    Tel√©fono
                </h3>
            
                <p>
                    11-2345-6789
                </p>
            </div>

            <div class="Email">
                <h3>
                    Email
                </h3>
            
                <p>
                    nicolasmosquera799@gmail.com
                </p>
            </div>

            <div class="Horario">
                <h3>
                    Horario
                </h3>
        
                <p>
                    9:00hs a 20:00hs
                </p>
            </div>
        </section>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Eliminar producto
            document.querySelectorAll('.btn-eliminar').forEach(button => {
                button.addEventListener('click', async () => {
                    const id = button.dataset.id;
                    if (confirm('¬øSeguro que quieres eliminar este producto?')) {
                        try {
                            const res = await fetch(`/api/productos/${id}`, {
                                method: 'DELETE'
                            });
                            if (res.ok) {
                                alert('Producto eliminado');
                                location.reload(); // recarga la p√°gina para actualizar listado
                            } else {
                                const data = await res.json();
                                alert('Error: ' + data.mensaje);
                            }
                        } catch (error) {
                            alert('Error al eliminar producto');
                        }
                    }
                });
            });

            // Editar producto (ejemplo b√°sico: redirigir a p√°gina de edici√≥n)
            document.querySelectorAll('.btn-editar').forEach(button => {
                button.addEventListener('click', () => {
                    const id = button.dataset.id;
                    window.location.href = `/productos/editar/${id}`;
                });
            });

            // A√±adir al carrito
            const carritoProductos = [];

            // Funci√≥n para calcular total sumando precios
            const calcularTotal = () => {
                return carritoProductos.reduce((acc, prod) => acc + prod.precio, 0);
            };

            // Delegamos eventos a todos los botones de agregar carrito
            document.querySelectorAll('.btn-agregar-carrito').forEach(boton => {
                boton.addEventListener('click', async (e) => {
                    e.preventDefault();

                    const productoId = e.target.dataset.id;
                    const precio = Number(e.target.dataset.precio);
                    const nombre = e.target.dataset.nombre;

                    // Agregar producto al array local
                    carritoProductos.push({ id: productoId, nombre, precio });

                    // Calcular total actualizado
                    const total = calcularTotal();

                    try {
                        const res = await fetch('/api/carrito', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                productos: carritoProductos,
                                total: total
                            })
                        });

                        const data = await res.json();
                        console.log('üõí Respuesta del servidor:', data);
                    } catch (error) {
                        console.error('‚ùå Error al a√±adir al carrito:', error);
                    }
                });
            });
        });
    </script>
</body>

</html>